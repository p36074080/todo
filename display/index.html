<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Couple Shared Memory - XR Display Dashboard" />
  <meta name="theme-color" content="#0f0f0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="記事牆" />
  <link rel="icon" type="image/png" href="images/t4.png" />
  <link rel="apple-touch-icon" href="images/t4.png" />
  <link rel="manifest" href="manifest.json" />
  <title>記事牆</title>

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Helvetica Neue", Arial, sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%; /* Use percentage for iOS 12 compatibility */
    }

    body {
      background: #0f0f0f;
      color: #f5f5f5;
      overflow: hidden;
      height: 100%; /* Fixed height for scroll to work */
    }

    .dashboard {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      height: 100%; /* Fixed height instead of min-height for scroll to work */
      padding: 24px;
      /* Safe area support for iOS PWA (iOS 12 will fallback to 0) */
      padding-top: calc(24px + env(safe-area-inset-top, 0px));
      padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px));
      padding-left: calc(24px + env(safe-area-inset-left, 0px));
      padding-right: calc(24px + env(safe-area-inset-right, 0px));
      box-sizing: border-box; /* Ensure padding is included in height */
    }
    
    /* Stable spacing between panels using sibling selector */
    .dashboard > *:not(:last-child) {
      margin-right: 24px;
    }

    /* 左側：Todo */
    .todo-panel {
      -webkit-flex: 1.1; /* Fallback for older iOS */
      flex: 1.1;
      background: #181818;
      border-radius: 18px;
      padding: 24px;
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-flex-direction: column; /* Fallback for older iOS */
      flex-direction: column;
      overflow: hidden;
      min-height: 0; /* Important for flex children to allow scrolling */
    }

    .panel-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .tabs {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-align-items: center; /* Fallback for older iOS */
      align-items: center;
      -webkit-justify-content: space-between; /* Fallback for older iOS */
      justify-content: space-between;
      margin-bottom: 20px;
      margin-left: -6px;
      margin-right: -6px;
    }
    
    .tabs-left {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      margin-left: 6px;
    }
    
    /* Stable spacing between tabs using sibling selector */
    .tabs-left .tab {
      margin-left: 0;
      margin-right: 0;
    }
    
    .tabs-left .tab + .tab {
      margin-left: 6px;
    }

    /* Scroll buttons container */
    .scroll-buttons {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-align-items: center; /* Fallback for older iOS */
      align-items: center;
      margin-right: 6px;
    }

    /* Stable spacing between scroll buttons - avoid using gap for iOS 12 */
    .scroll-buttons > *:not(:last-child) {
      margin-right: 8px;
    }

    .scroll-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: #2a2a2a;
      border: none;
      color: #f5f5f5;
      font-size: 18px;
      cursor: pointer;
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-align-items: center; /* Fallback for older iOS */
      align-items: center;
      -webkit-justify-content: center; /* Fallback for older iOS */
      justify-content: center;
      -webkit-transition: all 0.2s ease; /* Fallback for older iOS */
      transition: all 0.2s ease;
      opacity: 0.7;
      min-height: 44px; /* iOS minimum touch target */
    }

    .scroll-btn:hover {
      background: #3a3a3a;
      opacity: 1;
    }

    .scroll-btn:active {
      background: #4a4a4a;
      -webkit-transform: scale(0.95); /* Fallback for older iOS */
      transform: scale(0.95);
    }

    .scroll-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .tab {
      padding: 12px 20px; /* Increased padding */
      min-height: 44px; /* iOS minimum touch target */
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      background: #2a2a2a;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.6;
      user-select: none;
    }

    .tab.active {
      opacity: 1;
      background: #ffffff;
      color: #111;
      font-weight: 600;
    }

    .todo-list {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-flex-direction: column; /* Fallback for older iOS */
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden; /* Prevent horizontal scroll */
      -webkit-flex: 1; /* Fallback for older iOS */
      flex: 1;
      min-height: 0; /* Important for flex children to allow scrolling */
    }

    .todo-item {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-align-items: flex-start; /* Changed from center to flex-start for better alignment */
      align-items: flex-start;
      padding: 18px 20px; /* Match shopping list padding exactly */
      border-radius: 14px;
      background: #222;
      -webkit-transition: -webkit-transform 0.2s ease; /* Fallback for older iOS */
      transition: transform 0.2s ease;
      margin: 0; /* Reset margin */
      box-sizing: border-box; /* Ensure padding is included in height calculation */
      /* Ensure enough height for content */
      min-height: 115px; /* Fixed height as requested */
    }
    
    /* Stable spacing between todo items using sibling selector */
    .todo-item + .todo-item {
      margin-top: 16px; /* Stable, suitable for iPad dashboard */
    }
    
    /* Spacing between todo-item children */
    .todo-item > *:not(:last-child) {
      margin-right: 14px;
    }

    .todo-item:hover {
      -webkit-transform: translateX(4px); /* Fallback for older iOS */
      transform: translateX(4px);
    }

    .todo-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      -webkit-flex-shrink: 0; /* Fallback for older iOS */
      flex-shrink: 0;
      margin-top: 2px; /* Align with first line of text when align-items is flex-start */
    }

    /* 顏色語意 */
    .task { background: #4da3ff; }      /* 要做的事 */
    .discuss { background: #b48cff; }   /* 要討論 */
    .shopping { background: #5fd39c; }  /* 採買 */

    .todo-content {
      -webkit-flex: 1; /* Fallback for older iOS */
      flex: 1;
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-flex-direction: column; /* Fallback for older iOS */
      flex-direction: column;
      min-width: 0; /* Prevent flex item from overflowing */
      justify-content: flex-start; /* Align content to top */
    }
    
    /* Stable spacing between todo-content children */
    .todo-content > .todo-text {
      margin-bottom: 0; /* No margin for text, let item-meta-row handle spacing */
      flex-shrink: 0; /* Prevent text from shrinking */
    }

    .todo-content > .item-meta-row {
      margin-top: 12px; /* Increased spacing from text to match shopping list */
      margin-bottom: 0;
      flex-shrink: 0; /* Prevent meta row from shrinking */
    }

    .todo-text {
      font-size: 18px;
      line-height: 1.6; /* Slightly increased line height for better spacing */
      word-wrap: break-word; /* Ensure long text wraps properly */
      overflow-wrap: break-word; /* Additional wrapping support */
      margin: 0; /* Remove default margins */
      padding: 0; /* Remove default padding */
      min-height: 1.6em; /* Ensure at least one line of text height */
    }

    .priority-badge {
      font-size: 12px;
      padding: 8px 14px; /* Increased padding to match shopping list badge style */
      border-radius: 999px;
      font-weight: 500;
      line-height: 1.4; /* Increased line height for better visibility */
      display: inline-block; /* Better rendering on iOS 12 */
      vertical-align: middle; /* Align with images */
      margin: 0; /* Remove any default margins */
      box-sizing: border-box; /* Ensure padding is included */
      min-height: 28px; /* Ensure minimum height for badge */
    }

    .priority-high { background: #ff6b6b; color: #fff; }
    .priority-mid { background: #f5b971; color: #111; }
    .priority-low { background: #7bdff2; color: #111; }

    /* Assignee images */
    .assignee-images {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-align-items: center; /* Fallback for older iOS */
      align-items: center;
      -webkit-flex-shrink: 0; /* Fallback for older iOS */
      flex-shrink: 0;
      margin: 0; /* Remove margin to prevent overflow */
      padding: 0; /* Remove padding */
    }
    
    /* Stable spacing between assignee images */
    .assignee-images > *:not(:last-child) {
      margin-right: 4px;
    }

    .assignee-img {
      width: 30px;
      height: 30px;
      object-fit: cover;
      border-radius: 4px;
      display: block; /* Ensure proper rendering */
      flex-shrink: 0; /* Prevent image from shrinking */
    }

    /* Item meta row - for priority badge and assignee images */
    .item-meta-row {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-align-items: center; /* Fallback for older iOS */
      align-items: center;
      -webkit-justify-content: space-between; /* Fallback for older iOS */
      justify-content: space-between;
      margin-top: 12px; /* Increased top margin for better spacing from text */
      min-height: 36px; /* Increased minimum height to match shopping list */
      padding-top: 4px; /* Extra padding to prevent content from being cut off */
      padding-bottom: 2px; /* Add bottom padding for better spacing */
    }

    /* Stable spacing for item-meta-row children */
    .item-meta-row > *:not(:last-child) {
      margin-right: 8px;
    }

    /* 右側：行事曆 */
    .calendar-panel {
      -webkit-flex: 1; /* Fallback for older iOS */
      flex: 1;
      background: #181818;
      border-radius: 18px;
      padding: 24px;
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-flex-direction: column; /* Fallback for older iOS */
      flex-direction: column;
      position: relative; /* For bg.png absolute positioning */
      min-height: 0; /* Important for flex children to allow scrolling */
      /* Don't set overflow here - let calendar-content handle scrolling */
    }

    .calendar-bg-image {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 150px;
      height: auto;
      opacity: 0.3;
      pointer-events: none;
      z-index: 0;
      /* Fixed at bottom-right of calendar-panel viewport, doesn't scroll with content */
      /* Use position: absolute relative to calendar-panel, which has position: relative */
    }

    .calendar-content {
      position: relative;
      z-index: 1;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      /* This is the scrollable area - bg.png is outside this, so it stays fixed */
    }

    /* Make panel-title sticky within calendar-content */
    .calendar-content .panel-title {
      position: sticky;
      top: 0;
      background: #181818; /* Match panel background */
      z-index: 10;
      padding-bottom: 16px; /* Add padding to prevent content overlap */
      margin-bottom: 16px;
    }

    .calendar-day {
      border-bottom: 1px solid #2a2a2a;
      padding-bottom: 18px;
      margin-bottom: 18px;
    }

    .calendar-day:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .day-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      opacity: 0.9;
    }

    .event-list {
      display: -webkit-flex; /* Fallback for older iOS */
      display: flex;
      -webkit-flex-direction: column; /* Fallback for older iOS */
      flex-direction: column;
    }
    
    /* Stable spacing between events */
    .event-list > *:not(:last-child) {
      margin-bottom: 10px;
    }

    .event {
      font-size: 18px;
      line-height: 1.5;
    }

    .event-time {
      font-size: 14px;
      opacity: 0.6;
      margin-right: 8px;
      font-weight: 500;
    }

    .event-time-end {
      font-size: 14px;
      opacity: 0.5;
      margin-left: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      opacity: 0.5;
      font-size: 16px;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      opacity: 0.6;
      font-size: 16px;
    }

    /* Full screen loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .loading-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 強制橫向顯示 */
    @media screen and (orientation: portrait) {
      body::before {
        content: "請將裝置轉為橫向顯示";
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: #fff;
        padding: 20px 40px;
        border-radius: 12px;
        z-index: 9999;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <!-- 左：Todo -->
    <div class="todo-panel">
      <div class="panel-title">待辦事項</div>
      <div class="tabs">
        <div class="tabs-left">
          <div class="tab active" data-tab="todo">待辦事項</div>
          <div class="tab" data-tab="shopping">採買清單</div>
        </div>
        <div class="scroll-buttons">
          <button class="scroll-btn" id="scrollUpBtn" aria-label="向上滾動">↑</button>
          <button class="scroll-btn" id="scrollDownBtn" aria-label="向下滾動">↓</button>
        </div>
      </div>

      <div class="todo-list" id="todoList">
        <div class="loading">載入中...</div>
      </div>
    </div>

    <!-- 右：行事曆 -->
    <div class="calendar-panel">
      <img src="images/bg.png" alt="" class="calendar-bg-image" />
      <div class="calendar-content">
        <div class="panel-title">行事曆</div>
        <div id="calendarList">
          <div class="loading">載入中...</div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>
  </div>

  <script>
    // Configuration - 部署後請更新此 URL
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwSqmHIvJoI8Vk-w2fkY_Ehu7DXhmKg5toCDxoivB6aBVgUTgKD96DHzIqELFIQ8kvy6A/exec';
    
    // State
    let currentTab = 'todo';
    let cachedItems = null;
    let cachedCalendar = null;
    const CACHE_KEY_ITEMS = 'xr_items_cache';
    const CACHE_KEY_CALENDAR = 'xr_calendar_cache';
    const CACHE_TIMESTAMP_KEY = 'xr_cache_timestamp';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

    // Detect iOS PWA standalone mode
    const isStandalone =
      window.navigator.standalone === true ||
      window.matchMedia('(display-mode: standalone)').matches;
    
    document.documentElement.classList.toggle('is-standalone', isStandalone);

    // DOM elements
    const todoList = document.getElementById('todoList');
    const calendarList = document.getElementById('calendarList');
    const tabs = document.querySelectorAll('.tab');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const scrollUpBtn = document.getElementById('scrollUpBtn');
    const scrollDownBtn = document.getElementById('scrollDownBtn');

    // Initialize
    function init() {
      // Load cached data first
      loadCachedData();
      
      // Set up tabs
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentTab = tab.dataset.tab;
          // Show loading overlay when switching tabs
          loadingOverlay.classList.add('show');
          // Fetch fresh data when switching tabs
          fetchData();
        });
      });

      // Scroll functions
      function scrollTodoList(direction) {
        if (!todoList) return;
        
        const scrollAmount = 200; // Scroll distance in pixels
        const currentScrollTop = todoList.scrollTop;
        const maxScrollTop = todoList.scrollHeight - todoList.clientHeight;
        
        if (direction === 'up') {
          todoList.scrollTop = Math.max(0, currentScrollTop - scrollAmount);
        } else if (direction === 'down') {
          todoList.scrollTop = Math.min(maxScrollTop, currentScrollTop + scrollAmount);
        }
        
        // Update button states after scroll animation
        setTimeout(updateScrollButtons, 100);
      }

      function updateScrollButtons() {
        if (!scrollUpBtn || !scrollDownBtn || !todoList) return;
        
        const scrollTop = todoList.scrollTop;
        const scrollHeight = todoList.scrollHeight;
        const clientHeight = todoList.clientHeight;
        const maxScrollTop = scrollHeight - clientHeight;
        
        // Enable/disable buttons based on scroll position
        scrollUpBtn.disabled = scrollTop <= 0;
        scrollDownBtn.disabled = scrollTop >= maxScrollTop - 1; // -1 for rounding issues
      }

      // Set up scroll buttons
      if (scrollUpBtn && scrollDownBtn) {
        scrollUpBtn.addEventListener('click', () => scrollTodoList('up'));
        scrollDownBtn.addEventListener('click', () => scrollTodoList('down'));
        
        // Update button states when scrolling
        todoList.addEventListener('scroll', updateScrollButtons);
        
        // Update button states after initial render
        setTimeout(updateScrollButtons, 300);
      }

      // Initial load
      fetchData();
      
      // Auto-refresh data every 7 minutes
      setInterval(fetchData, 7 * 60 * 1000); // 7 minutes
      
      // Auto-refresh page every 30 minutes
      setInterval(() => {
        location.reload();
      }, 30 * 60 * 1000); // 30 minutes
    }

    // Load cached data from localStorage
    function loadCachedData() {
      try {
        const cached = localStorage.getItem(CACHE_KEY_ITEMS);
        const cachedCal = localStorage.getItem(CACHE_KEY_CALENDAR);
        const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
        
        if (cached && timestamp && Date.now() - parseInt(timestamp) < CACHE_DURATION) {
          cachedItems = JSON.parse(cached);
          renderItems();
        }
        
        if (cachedCal && timestamp && Date.now() - parseInt(timestamp) < CACHE_DURATION) {
          cachedCalendar = JSON.parse(cachedCal);
          renderCalendar();
        }
      } catch (e) {
        console.error('Failed to load cache:', e);
      }
    }

    // Fetch data from API
    async function fetchData() {
      if (!API_BASE_URL || API_BASE_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
        console.error('Please set API_BASE_URL in the script');
        todoList.innerHTML = '<div class="empty-state">請設定 API URL</div>';
        return;
      }

      try {
        // Fetch items
        const itemsUrl = `${API_BASE_URL}?action=items&view=xr&type=${currentTab}&status=active`;
        const itemsResponse = await fetch(itemsUrl);
        const itemsData = await itemsResponse.json();
        
        if (itemsData.items) {
          cachedItems = itemsData.items;
          localStorage.setItem(CACHE_KEY_ITEMS, JSON.stringify(cachedItems));
          localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
          renderItems();
        }

        // Fetch calendar
        const calendarUrl = `${API_BASE_URL}?action=calendar&days=5`;
        const calendarResponse = await fetch(calendarUrl);
        const calendarData = await calendarResponse.json();
        
        if (calendarData.days) {
          cachedCalendar = calendarData.days;
          localStorage.setItem(CACHE_KEY_CALENDAR, JSON.stringify(cachedCalendar));
          renderCalendar();
        }
        
        // Remove loading overlay after data is loaded
        setTimeout(() => {
          loadingOverlay.classList.remove('show');
        }, 300);
      } catch (error) {
        console.error('Failed to fetch data:', error);
        loadingOverlay.classList.remove('show');
        // Show cached data if available
        if (cachedItems) renderItems();
        if (cachedCalendar) renderCalendar();
      }
    }

    // Render items list
    function renderItems() {
      if (!cachedItems) {
        todoList.innerHTML = '<div class="loading">載入中...</div>';
        return;
      }

      const filtered = cachedItems.filter(item => item.type === currentTab && item.status === 'active');
      
      if (filtered.length === 0) {
        todoList.innerHTML = '<div class="empty-state">目前沒有項目</div>';
        return;
      }

      // Sort: priority (high -> mid -> low), then updatedAt desc
      const priorityOrder = { high: 1, mid: 2, low: 3 };
      filtered.sort((a, b) => {
        const priorityDiff = (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
        if (priorityDiff !== 0) return priorityDiff;
        return (b.updatedAt || 0) - (a.updatedAt || 0);
      });

      todoList.innerHTML = filtered.map(item => {
        const subtype = item.subtype || (item.type === 'shopping' ? 'shopping' : 'task');
        const priorityLabel = {
          high: '緊急',
          mid: '還行',
          low: '不急'
        }[item.priority] || item.priority;
        const assignee = item.assignee || '';

        // Generate assignee images HTML
        let assigneeHtml = '';
        if (assignee) {
          if (assignee === '熊熊＆貓貓' || assignee === '熊熊&貓貓') {
            assigneeHtml = `
              <div class="assignee-images">
                <img src="images/bear.png" alt="熊熊" class="assignee-img" />
                <img src="images/cat.png" alt="貓貓" class="assignee-img" />
              </div>
            `;
          } else if (assignee === '熊熊') {
            assigneeHtml = `
              <div class="assignee-images">
                <img src="images/bear.png" alt="熊熊" class="assignee-img" />
              </div>
            `;
          } else if (assignee === '貓貓') {
            assigneeHtml = `
              <div class="assignee-images">
                <img src="images/cat.png" alt="貓貓" class="assignee-img" />
              </div>
            `;
          }
        }

        return `
          <div class="todo-item">
            <div class="todo-dot ${subtype}"></div>
            <div class="todo-content">
              <div class="todo-text">${escapeHtml(item.text)}</div>
              <div class="item-meta-row">
                <div class="priority-badge priority-${item.priority}">${priorityLabel}</div>
                ${assigneeHtml}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Update scroll buttons after rendering
      setTimeout(() => {
        if (scrollUpBtn && scrollDownBtn && todoList) {
          const scrollTop = todoList.scrollTop;
          const scrollHeight = todoList.scrollHeight;
          const clientHeight = todoList.clientHeight;
          const maxScrollTop = scrollHeight - clientHeight;
          
          scrollUpBtn.disabled = scrollTop <= 0;
          scrollDownBtn.disabled = scrollTop >= maxScrollTop - 1;
        }
      }, 100);
    }

    // Render calendar
    function renderCalendar() {
      if (!cachedCalendar) {
        calendarList.innerHTML = '<div class="loading">載入中...</div>';
        return;
      }

      if (cachedCalendar.length === 0) {
        calendarList.innerHTML = '<div class="empty-state">未來五天沒有活動</div>';
        return;
      }

      calendarList.innerHTML = cachedCalendar.map(day => {
        // 轉換日期標籤為中文
        let dayLabel = day.label;
        if (dayLabel === 'Today') dayLabel = '今天';
        else if (dayLabel === 'Tomorrow') dayLabel = '明天';
        else if (dayLabel === 'Day+2') dayLabel = '後天';
        
        const eventsHtml = day.events.length > 0
          ? day.events.map(event => {
              // 顯示開始時間和結束時間
              const timeDisplay = event.end 
                ? `${event.start} - ${event.end}`
                : event.start;
              return `
                <div class="event">
                  <span class="event-time">${timeDisplay}</span>
                  ${escapeHtml(event.title)}
                </div>
              `;
            }).join('')
          : '<div class="empty-state" style="padding: 10px 0;">沒有活動</div>';

        return `
          <div class="calendar-day">
            <div class="day-title">${dayLabel}（${formatDateDisplay(day.date)}）</div>
            <div class="event-list">${eventsHtml}</div>
          </div>
        `;
      }).join('');
    }

    // Helper: Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Helper: Format date for display
    function formatDateDisplay(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${month}/${day}`;
    }

    // Start app
    init();
  </script>
</body>
</html>
